name: Native CI Build

on:
  pull_request:
  push:
    branches:
      - '**'
  workflow_dispatch:

concurrency:
  group: native-ci-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install
        run: npm ci
      - name: Clean native artifacts (react-native-reanimated)
        run: |
          rm -rf node_modules/react-native-reanimated/android/build || true
          rm -rf node_modules/react-native-reanimated/android/.cxx || true
      - name: Build Android
        working-directory: android
        env:
          NODE_ENV: development
        run: |
          chmod +x gradlew
          ./gradlew clean --no-daemon --warning-mode all
          ../node_modules/.bin/react-native config || true
          ./gradlew assembleDebug -x lint --no-daemon --no-parallel --warning-mode all --stacktrace
      - name: Verify artifacts
        run: node scripts/ci/check-native-artifacts.js || (ls android/app/build/outputs/apk/debug && exit 0)

  build-ios:
    runs-on: macos-latest
    if: ${{ github.event_name == 'push' || github.event_name == 'pull_request' }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install
        run: npm ci
      - name: Pod install & Build (iOS) if workspace present
        run: |
          if [ -f ios/Podfile ] ; then
            cd ios && pod install && xcodebuild -workspace "$(ls | grep .xcworkspace | head -n 1)" -scheme "RahcApp" -configuration Debug -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 14' build CODE_SIGNING_ALLOWED=NO ;
          else
            echo "No iOS workspace found â€” skipping iOS build";
          fi
      - name: Verify iOS artifacts
        run: node ./scripts/ci/check-native-artifacts.js --ios || exit 0
