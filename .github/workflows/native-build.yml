name: Native CI Build

on:
  pull_request:
  push:
    branches:
      - '**'
  workflow_dispatch:

concurrency:
  group: native-ci-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false
          gradle-version: wrapper
      
      - name: Install Node dependencies
        run: npm ci
      
      - name: Clean native artifacts (react-native-reanimated)
        run: |
          rm -rf node_modules/react-native-reanimated/android/build || true
          rm -rf node_modules/react-native-reanimated/android/.cxx || true
      
      - name: Patch Reanimated Gradle DSL for Gradle 8
        run: node scripts/ci/patch-reanimated-gradle.js
      
      # Only build one architecture for CI to save time
      - name: Build Android
        working-directory: android
        env:
          NODE_ENV: development
          ORG_GRADLE_PROJECT_reactNativeArchitectures: arm64-v8a
          ORG_GRADLE_PROJECT_newArchEnabled: "true"
        run: |
          chmod +x gradlew
          ./gradlew clean --warning-mode all
          ../node_modules/.bin/react-native config || true
          ./gradlew assembleDebug -x lint --warning-mode all --stacktrace --max-workers=2
      
      - name: Verify artifacts
        run: node scripts/ci/check-native-artifacts.js || (ls android/app/build/outputs/apk/debug && exit 0)
      - name: Upload debug APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-debug-apk
          path: android/app/build/outputs/apk/debug/*.apk
          retention-days: 7
      - name: Upload Proguard/R8 mapping (if present)
        uses: actions/upload-artifact@v4
        with:
          name: android-mapping
          path: |
            android/app/build/outputs/mapping/debug/mapping.txt
            android/app/build/outputs/mapping/release/mapping.txt
          if-no-files-found: ignore
          retention-days: 7

  build-ios:
    runs-on: macos-latest
    if: ${{ github.event_name == 'push' || github.event_name == 'pull_request' }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install
        run: npm ci
      - name: Pod install & Build (iOS) if workspace present
        run: |
          if [ -f ios/Podfile ] ; then
            cd ios && pod install && xcodebuild -workspace "$(ls | grep .xcworkspace | head -n 1)" -scheme "RahcApp" -configuration Debug -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 14' -derivedDataPath build/DerivedData build CODE_SIGNING_ALLOWED=NO ;
          else
            echo "No iOS workspace found â€” skipping iOS build";
          fi
      - name: Verify iOS artifacts
        run: node ./scripts/ci/check-native-artifacts.js --ios || exit 0
      - name: Upload iOS simulator build products (if present)
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-build
          path: ios/build/DerivedData/Build/Products
          if-no-files-found: ignore
          retention-days: 7
